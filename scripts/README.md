# EU4 AI Training Scripts

Python scripts for training ML models on EU4 simulation data.

## Setup

### Prerequisites

1. **Python 3.11+** - Required for type hints and modern features
2. **Cap'n Proto compiler** - Required for pycapnp

   ```bash
   # Linux/macOS
   brew install capnp   # or apt-get install capnproto

   # Windows (via Chocolatey)
   choco install capnproto

   # Or download from https://capnproto.org/install.html
   ```

### Installation

```bash
cd scripts

# Using uv (recommended)
uv sync

# Or using pip
pip install -e .
```

## Training Data Formats

The training pipeline supports two data formats:

### Cap'n Proto Binary (Preferred)

Zero-copy binary format defined in `schemas/training.capnp`. Generated by the Rust simulation with `--datagen` flag.

```bash
# Load and inspect binary training data
python load_training_data.py training.bin --stats

# Train on binary data
python train_ai.py --data training.bin
```

### JSON Lines (Legacy)

Text-based format for debugging and compatibility.

```bash
python train_ai.py --data training.jsonl
```

## Scripts

### `train_ai.py`

Train a LoRA adapter on EU4 simulation data.

```bash
python train_ai.py \
    --data training.bin \
    --base-model google/gemma-2-2b-it \
    --output models/adapter \
    --epochs 3
```

Options:
- `--data` - Path to training data (.bin or .jsonl)
- `--base-model` - HuggingFace model ID (default: gemma-2-2b-it)
- `--output` - Output directory for trained adapter
- `--epochs` - Number of training epochs

### `load_training_data.py`

Inspect and convert Cap'n Proto training data.

```bash
# Show statistics
python load_training_data.py training.bin --stats

# Show sample prompts
python load_training_data.py training.bin --samples 5

# Filter by country
python load_training_data.py training.bin --stats --country TUR
```

## Schema

The training data schema is defined in `schemas/training.capnp`. This is the single source of truth for both Rust and Python types.

Key structures:
- `TrainingSample` - One decision point (state + available actions + chosen action)
- `VisibleWorldState` - What the AI can see about the game
- `Command` - All possible game commands (move, recruit, declare war, etc.)

See `schemas/README.md` for schema evolution guidelines.

## Development

```bash
# Format code
ruff format .

# Lint
ruff check .
```
