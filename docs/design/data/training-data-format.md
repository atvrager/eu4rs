# Training Data Format

This document describes the binary training data format used for ML model training.

## Overview

Training data is generated by the simulation and consumed by Python ML pipelines. The format uses [Cap'n Proto](https://capnproto.org/) for:

- **Type safety**: Shared schema ensures Rust and Python types stay in sync
- **Performance**: ~10x faster than JSON serialization
- **Zero-copy reads**: Python can access data without deserialization overhead

## File Formats

### Binary Archive (Recommended)

**Extension**: `.cpb.zip`

A ZIP archive containing Cap'n Proto binary files, one per simulated year:

```
training.cpb.zip/
  1444.cpb    (TrainingBatch for year 1444)
  1445.cpb    (TrainingBatch for year 1445)
  ...
```

Generate with:
```bash
cargo run -p eu4sim -- --datagen training.cpb.zip --ticks 3650 --headless
```

### Single Binary File

**Extension**: `.cpb`

A single `TrainingFile` message containing all batches. More compact but less flexible for streaming.

### Legacy Formats

- `.zip` - JSON archive (JSONL files per year, deflate compressed)
- `.jsonl` - Streaming JSONL (one sample per line)

## Schema

The schema is defined in `schemas/training.capnp`. Key structures:

### TrainingSample

A single training sample containing:

| Field | Type | Description |
|-------|------|-------------|
| `tick` | UInt64 | Simulation tick (days since start) |
| `country` | Text | Country tag (e.g., "FRA") |
| `state` | VisibleWorldState | Country's view of the world |
| `availableCommands` | List(Command) | Legal actions |
| `chosenAction` | Int32 | Index into availableCommands (-1 for Pass) |
| `chosenCommand` | Command | The command that was executed |

### VisibleWorldState

The country's perspective of the game state:

| Field | Type | Description |
|-------|------|-------------|
| `date` | Date | Current game date |
| `observer` | Text | Observing country tag |
| `ownCountry` | CountryState | Detailed state of this country |
| `atWar` | Bool | Whether currently at war |
| `knownCountries` | List(Text) | Tags of known countries |
| `enemyProvinces` | List(UInt32) | Province IDs owned by enemies |
| `knownCountryStrength` | List(Entry) | Relative strength estimates |
| `ourWarScore` | List(Entry) | War scores by war ID |

### CountryState

Detailed country statistics:

| Field | Type | Description |
|-------|------|-------------|
| `treasury` | Fixed | Current gold |
| `manpower` | Fixed | Available manpower |
| `stability` | Int8 | -3 to +3 |
| `prestige` | Fixed | -100 to +100 |
| `armyTradition` | Fixed | 0 to 100 |
| `admMana/dipMana/milMana` | Fixed | Monarch points |
| `admTech/dipTech/milTech` | UInt8 | Technology levels |
| `religion` | Text | Religion ID |
| `embracedInstitutions` | List(Text) | Institution IDs |

### Command

A union type representing all possible actions. See `schemas/training.capnp` for the full list (~40 command types).

## Python Usage

### Loading Data

```python
from load_training_data import load_training_file, to_huggingface_dataset

# Load from binary archive
samples = load_training_file("training.cpb.zip")

# Convert to HuggingFace Dataset
dataset = to_huggingface_dataset(samples)
```

### Inspecting Samples

```python
for sample in samples[:5]:
    print(f"Tick {sample.tick}: {sample.country}")
    print(f"  Treasury: {sample.state.own_country.treasury}")
    print(f"  Actions: {len(sample.available_commands)}")
    print(f"  Chosen: [{sample.chosen_action}] {sample.chosen_command}")
```

### CLI Inspection

```bash
cd scripts
uv run load_training_data.py training.cpb.zip --stats --samples 3
```

## Rust Usage

### Generating Data

```rust
use eu4sim_core::DataGenObserver;

// Binary archive (recommended)
let observer = DataGenObserver::file("training.cpb.zip")?;

// JSON archive (legacy)
let observer = DataGenObserver::file("training.zip")?;

// Streaming JSONL (legacy)
let observer = DataGenObserver::file("training.jsonl")?;
```

### Direct Serialization

```rust
use eu4sim_core::observer::capnp_serialize;

let samples: Vec<TrainingSample> = ...;
let mut buf = Vec::new();
capnp_serialize::serialize_batch(&mut buf, 1444, &samples)?;
```

## Schema Evolution

Cap'n Proto supports forward-compatible schema changes:

1. **Add new fields** at the end with the next ordinal number
2. **Never reuse ordinals** - deleted fields leave gaps
3. **Never reorder** - ordinals are wire format

Example:
```capnp
struct Foo {
  name @0 :Text;
  deprecatedAge @1 :UInt8;  # Was: age
  email @2 :Text;           # Added in v2
  phone @3 :Text;           # Added in v3
}
```

Old readers can read new data (unknown fields ignored).
New readers can read old data (new fields have defaults).

## Performance

Typical throughput on a 4-core machine:

| Format | Write Speed | Read Speed | File Size |
|--------|-------------|------------|-----------|
| `.cpb.zip` | ~500k samples/sec | ~1M samples/sec | Smallest |
| `.zip` (JSON) | ~50k samples/sec | ~100k samples/sec | Medium |
| `.jsonl` | ~100k samples/sec | ~200k samples/sec | Largest |

Binary format is ~10x faster for both serialization and deserialization.

## See Also

- [schemas/training.capnp](../../../schemas/training.capnp) - Schema definition
- [schemas/README.md](../../../schemas/README.md) - Build instructions
- [scripts/load_training_data.py](../../../scripts/load_training_data.py) - Python loader
