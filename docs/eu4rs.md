# eu4rs (Binary)

The `eu4rs` crate is the main entry point for the application. It brings together the windowing system, renderer, and game data logic to create the interactive application.

## Architecture

The application loop is structured around the `winit` event loop and a centralized `State` struct that manages the application lifecycle.

### Core Components

-   **`main.rs`**: Handles command-line arguments (using `clap`) and initializes the appropriate mode (Interactive Window or Snapshot).
-   **`window.rs`**: Contains the bulk of the application logic.
    -   **`State`**: The main struct holding the Window, Surface, Device, Queue, and Renderer. It handles window events (Resize, Redraw, Input).
    -   **`Eu4Renderer`**: A decoupled rendering struct. It owns the `wgpu` RenderPipeline, BindGroups, and Textures. It can be initialized with a window (for interactive mode) or without one (for headless mode).

## Rendering Pipeline

We use `wgpu` with a preference for the **Vulkan** backend.

1.  **Vertex Shader**: Generates a full-screen triangle ("Big Triangle" optimization) to cover the screen without needing vertex buffers.
2.  **Fragment Shader**: Samples the province map texture (`provinces.bmp`) using UV coordinates generated by the vertex shader.
3.  **Texture Loading**: The `provinces.bmp` is loaded using the `image` crate and uploaded to the GPU as a `Texture`.

## Camera System
We use a custom `Camera` struct to handle 2D navigation:
- **Zoom**: Anchored to the mouse cursor.
- **Pan**: Middle-click drag, supports infinite X-axis wrapping (simulating a globe).
- **Uniforms**: The camera state is sent to the GPU via a Uniform Buffer (`[x, y, inv_zoom_x, inv_zoom_y]`), allowing the vertex/fragment shaders to transform screen coordinates to texture coordinates efficiently.

## Province Inspector
The application includes an "Inspector" window that renders text info for selected provinces.
- **Picking**: Converts mouse clicks (screen space) to texture space using the Camera's transform to look up Province IDs from the map data.
- **Rendering**: Uses `wgpu` to render a dynamic text texture containing game data (Province ID, Owner, Trade Goods).


To support automated regression testing, `eu4rs` supports a headless "Snapshot" mode.

-   **Command**: `cargo run -- snapshot --output <path>`
-   **Mechanism**:
    1.  Initializes a `wgpu` Instance and Adapter *without* a Surface.
    2.  Creates an **Offscreen Texture** and a compatible **Output Buffer**.
    3.  Renders the scene to the texture.
    4.  Copies the texture to the buffer.
    5.  Maps the buffer to read the bytes back to the CPU.
    6.  Saves the bytes as a PNG image.
-   **CI/CD**: If no suitable GPU adapter is found (common in CI runners), the snapshot command exits gracefully with a warning, ensuring the build pipeline doesn't fail.
